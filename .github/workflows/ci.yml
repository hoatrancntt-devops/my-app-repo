name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    # 1. Login Harbor
    - name: Login to Harbor
      uses: docker/login-action@v1
      with:
        registry: harbor.devopsviet.io.vn
        username: ${{ secrets.HARBOR_ROBOT_USER }}
        password: ${{ secrets.HARBOR_ROBOT_TOKEN }}
        
    # 2. Build & Push Image
    - name: Build and Push
      run: |
        docker build -t harbor.devopsviet.io.vn/hoatranlab/hoa-hello:${{ github.sha }} .
        docker push harbor.devopsviet.io.vn/hoatranlab/hoa-hello:${{ github.sha }}
        
    # 3. Update Helm Values (GitOps)
    - name: Update Helm Values
      run: |
        sed -i 's/tag: .*/tag: "${{ github.sha }}"/' values.yaml
        git config --global user.email "ci@hoatranlab.io.vn"
        git config --global user.name "CI Bot"
        git commit -am "Update image tag to ${{ github.sha }}"
        git push