name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

# CẤP QUYỀN GHI (Write) ĐỂ GIT PUSH THÀNH CÔNG
permissions:
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    # Login vào Harbor
    - name: Login to Harbor
      uses: docker/login-action@v3
      with:
        registry: harbor.devopsviet.io.vn
        username: ${{ secrets.HARBOR_USERNAME }}
        password: ${{ secrets.HARBOR_PASSWORD }}
        
    # Đóng gói và Đẩy ảnh lên
    - name: Build and Push
      run: |
        docker build -t harbor.devopsviet.io.vn/hoatranlab/hoa-hello:${{ github.sha }} .
        docker push harbor.devopsviet.io.vn/hoatranlab/hoa-hello:${{ github.sha }}
        
    # Sửa file values.yaml và Commit lại
    - name: Update Helm Values
      run: |
        git config --global user.email "ci@hoatranlab.io.vn"
        git config --global user.name "CI Bot"
        
        # Lệnh sed thay thế tag cũ bằng hash mới
        sed -i 's/tag: .*/tag: "${{ github.sha }}"/' values.yaml
        
        git add values.yaml
        git commit -m "Update image tag to ${{ github.sha }}"
        git push
